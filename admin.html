<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitPanel - GitHub Repository Manager</title>
    <style>
        :root {
            --primary: #24292e;
            --secondary: #f6f8fa;
            --accent: #0366d6;
            --border: #e1e4e8;
            --success: #28a745;
            --danger: #d73a49;
            --warning: #ffd33d;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: var(--secondary);
            color: #333;
            line-height: 1.6;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .auth-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        
        .container {
            display: flex;
            min-height: calc(100vh - 60px);
        }
        
        .sidebar {
            width: 250px;
            background-color: white;
            border-right: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
        }
        
        .main-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .repo-list {
            list-style: none;
        }
        
        .repo-item {
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 3px;
            margin-bottom: 0.25rem;
        }
        
        .repo-item:hover {
            background-color: var(--secondary);
        }
        
        .repo-item.active {
            background-color: var(--accent);
            color: white;
        }
        
        .file-explorer {
            display: flex;
            margin-top: 1rem;
        }
        
        .file-tree {
            width: 250px;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.5rem;
            margin-right: 1rem;
            overflow-y: auto;
            max-height: 70vh;
        }
        
        .file-content {
            flex: 1;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 1rem;
        }
        
        .file-item {
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
        }
        
        .file-item:hover {
            background-color: var(--secondary);
        }
        
        .file-item .icon {
            margin-right: 0.5rem;
            width: 16px;
            text-align: center;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: 3px;
        }
        
        .breadcrumb-item {
            cursor: pointer;
            color: var(--accent);
        }
        
        .breadcrumb-item:hover {
            text-decoration: underline;
        }
        
        .breadcrumb-separator {
            margin: 0 0.5rem;
            color: #666;
        }
        
        .editor {
            width: 100%;
            height: 400px;
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.5rem;
            font-family: monospace;
            resize: vertical;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-primary {
            background-color: var(--accent);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: #333;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .commit-section {
            margin-top: 1rem;
            padding: 1rem;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: 3px;
        }
        
        .commit-message {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 3px;
            margin-bottom: 0.5rem;
        }
        
        .commit-history {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.5rem;
            background-color: white;
        }
        
        .commit-item {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .commit-item:last-child {
            border-bottom: none;
        }
        
        .commit-meta {
            font-size: 0.8rem;
            color: #666;
        }
        
        .pages-section {
            margin-top: 1rem;
            padding: 1rem;
            background-color: white;
            border: 1px solid var(--border);
            border-radius: 3px;
        }
        
        .pages-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-active {
            background-color: var(--success);
        }
        
        .status-inactive {
            background-color: #ccc;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 3px;
            width: 500px;
            max-width: 90%;
        }
        
        .modal-title {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 500;
        }
        
        .modal-body {
            margin-bottom: 1rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 3px;
        }
        
        .tab-container {
            margin-top: 1rem;
        }
        
        .tab-header {
            display: flex;
            border-bottom: 1px solid var(--border);
        }
        
        .tab-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn.active {
            border-bottom: 2px solid var(--accent);
            font-weight: 500;
        }
        
        .tab-content {
            padding: 1rem 0;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .file-upload {
            margin-top: 1rem;
            padding: 1rem;
            border: 1px dashed var(--border);
            border-radius: 3px;
            text-align: center;
        }
        
        .checkbox-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.25rem 0;
        }
        
        .checkbox-item input {
            margin-right: 0.5rem;
        }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">GitPanel</div>
        <div class="auth-info" id="authInfo">
            <span id="username">Loading...</span>
            <img id="userAvatar" class="avatar" src="" alt="User Avatar">
        </div>
    </header>
    
    <div class="container">
        <div class="sidebar">
            <h3>Repositories</h3>
            <ul class="repo-list" id="repoList">
                <li>Loading repositories...</li>
            </ul>
        </div>
        
        <div class="main-content">
            <div id="repoView" style="display: none;">
                <h2 id="repoName">Repository</h2>
                <div class="toolbar">
                    <div class="btn-group">
                        <button class="btn btn-primary" id="refreshRepo">Refresh</button>
                        <button class="btn btn-primary" id="createFile">New File</button>
                        <button class="btn btn-primary" id="uploadFile">Upload</button>
                        <button class="btn btn-warning" id="zipFiles">Zip Selected</button>
                    </div>
                    <div class="btn-group">
                        <button class="btn" id="pagesBtn">GitHub Pages</button>
                    </div>
                </div>
                
                <div class="tab-container">
                    <div class="tab-header">
                        <button class="tab-btn active" data-tab="files">Files</button>
                        <button class="tab-btn" data-tab="history">History</button>
                    </div>
                    
                    <div class="tab-content active" id="filesTab">
                        <div class="breadcrumb" id="breadcrumb">
                            <span class="breadcrumb-item" data-path="">Home</span>
                        </div>
                        
                        <div class="file-explorer">
                            <div class="file-tree" id="fileTree">
                                Loading files...
                            </div>
                            
                            <div class="file-content" id="fileContent">
                                <p>Select a file to view or edit</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="historyTab">
                        <div class="commit-history" id="commitHistory">
                            Loading commit history...
                        </div>
                    </div>
                </div>
                
                <div class="commit-section" id="commitSection" style="display: none;">
                    <h4>Commit Changes</h4>
                    <input type="text" class="commit-message" id="commitMessage" placeholder="Enter commit message">
                    <div class="btn-group">
                        <button class="btn btn-success" id="commitChanges">Commit</button>
                        <button class="btn btn-danger" id="discardChanges">Discard</button>
                    </div>
                </div>
            </div>
            
            <div id="welcomeView">
                <h2>Welcome to GitPanel</h2>
                <p>Select a repository from the sidebar to get started.</p>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="createFileModal">
        <div class="modal-content">
            <div class="modal-title">Create New File</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="newFileName">File Path</label>
                    <input type="text" class="form-control" id="newFileName" placeholder="e.g., docs/README.md">
                </div>
                <div class="form-group">
                    <label class="form-label" for="newFileContent">Content</label>
                    <textarea class="form-control editor" id="newFileContent" rows="10"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelCreateFile">Cancel</button>
                <button class="btn btn-primary" id="confirmCreateFile">Create</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="uploadFileModal">
        <div class="modal-content">
            <div class="modal-title">Upload Files</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="uploadPath">Upload to Path</label>
                    <input type="text" class="form-control" id="uploadPath" placeholder="e.g., docs/">
                </div>
                <div class="file-upload">
                    <input type="file" id="fileUpload" multiple>
                    <p>Drag and drop files here or click to select</p>
                </div>
                <div id="zipOptions" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="extractZip"> Extract ZIP contents
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelUpload">Cancel</button>
                <button class="btn btn-primary" id="confirmUpload">Upload</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="zipFilesModal">
        <div class="modal-content">
            <div class="modal-title">Create ZIP Archive</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="zipFileName">ZIP File Name</label>
                    <input type="text" class="form-control" id="zipFileName" placeholder="e.g., archive.zip">
                </div>
                <div class="form-group">
                    <label class="form-label">Select Files/Folders</label>
                    <div class="checkbox-list" id="zipFileList">
                        Loading files...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelZip">Cancel</button>
                <button class="btn btn-primary" id="confirmZip">Create ZIP</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="pagesModal">
        <div class="modal-content">
            <div class="modal-title">GitHub Pages</div>
            <div class="modal-body">
                <div class="pages-status">
                    <div class="status-indicator" id="pagesStatusIndicator"></div>
                    <span id="pagesStatusText">Loading status...</span>
                </div>
                <div class="form-group">
                    <label class="form-label" for="pagesBranch">Source Branch</label>
                    <select class="form-control" id="pagesBranch" disabled>
                        <option>Loading branches...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="pagesPath">Source Path</label>
                    <select class="form-control" id="pagesPath" disabled>
                        <option>/ (root)</option>
                        <option>/docs</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="pagesCNAME">Custom Domain (CNAME)</label>
                    <input type="text" class="form-control" id="pagesCNAME" placeholder="example.com" disabled>
                </div>
                <div id="pagesUrl" style="margin-top: 1rem;">
                    <a href="#" target="_blank" id="pagesUrlLink">View your site</a>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closePagesModal">Close</button>
                <button class="btn btn-primary" id="savePagesSettings" disabled>Save Settings</button>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let accessToken = '';
        let currentUser = null;
        let currentRepo = null;
        let currentPath = '';
        let currentFile = null;
        let fileEditor = null;
        let fileContentOriginal = '';
        let selectedFilesForZip = [];
        
        // DOM elements
        const authInfoEl = document.getElementById('authInfo');
        const usernameEl = document.getElementById('username');
        const userAvatarEl = document.getElementById('userAvatar');
        const repoListEl = document.getElementById('repoList');
        const repoViewEl = document.getElementById('repoView');
        const welcomeViewEl = document.getElementById('welcomeView');
        const repoNameEl = document.getElementById('repoName');
        const fileTreeEl = document.getElementById('fileTree');
        const fileContentEl = document.getElementById('fileContent');
        const breadcrumbEl = document.getElementById('breadcrumb');
        const commitSectionEl = document.getElementById('commitSection');
        const commitMessageEl = document.getElementById('commitMessage');
        const commitHistoryEl = document.getElementById('commitHistory');
        const refreshRepoBtn = document.getElementById('refreshRepo');
        const createFileBtn = document.getElementById('createFile');
        const uploadFileBtn = document.getElementById('uploadFile');
        const zipFilesBtn = document.getElementById('zipFiles');
        const commitChangesBtn = document.getElementById('commitChanges');
        const discardChangesBtn = document.getElementById('discardChanges');
        const pagesBtn = document.getElementById('pagesBtn');
        
        // Modal elements
        const createFileModal = document.getElementById('createFileModal');
        const newFileNameEl = document.getElementById('newFileName');
        const newFileContentEl = document.getElementById('newFileContent');
        const cancelCreateFileBtn = document.getElementById('cancelCreateFile');
        const confirmCreateFileBtn = document.getElementById('confirmCreateFile');
        
        const uploadFileModal = document.getElementById('uploadFileModal');
        const uploadPathEl = document.getElementById('uploadPath');
        const fileUploadEl = document.getElementById('fileUpload');
        const zipOptionsEl = document.getElementById('zipOptions');
        const extractZipEl = document.getElementById('extractZip');
        const cancelUploadBtn = document.getElementById('cancelUpload');
        const confirmUploadBtn = document.getElementById('confirmUpload');
        
        const zipFilesModal = document.getElementById('zipFilesModal');
        const zipFileNameEl = document.getElementById('zipFileName');
        const zipFileListEl = document.getElementById('zipFileList');
        const cancelZipBtn = document.getElementById('cancelZip');
        const confirmZipBtn = document.getElementById('confirmZip');
        
        const pagesModal = document.getElementById('pagesModal');
        const pagesStatusIndicatorEl = document.getElementById('pagesStatusIndicator');
        const pagesStatusTextEl = document.getElementById('pagesStatusText');
        const pagesBranchEl = document.getElementById('pagesBranch');
        const pagesPathEl = document.getElementById('pagesPath');
        const pagesCNAMEEl = document.getElementById('pagesCNAME');
        const pagesUrlLinkEl = document.getElementById('pagesUrlLink');
        const closePagesModalBtn = document.getElementById('closePagesModal');
        const savePagesSettingsBtn = document.getElementById('savePagesSettings');
        
        // Tab elements
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', initApp);
        
        function initApp() {
            // Parse access token from URL hash
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            accessToken = params.get('access_token');
            
            if (!accessToken) {
                showError('Access token not found in URL. Please authenticate with GitHub first.');
                return;
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Load user data
            loadUserData();
            
            // Load repositories
            loadRepositories();
        }
        
        function setupEventListeners() {
            // Tab switching
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Repository actions
            refreshRepoBtn.addEventListener('click', () => {
                if (currentRepo) {
                    loadRepoContents(currentRepo, currentPath);
                    loadCommitHistory(currentRepo);
                }
            });
            
            createFileBtn.addEventListener('click', showCreateFileModal);
            uploadFileBtn.addEventListener('click', showUploadFileModal);
            zipFilesBtn.addEventListener('click', showZipFilesModal);
            pagesBtn.addEventListener('click', showPagesModal);
            
            // File creation modal
            cancelCreateFileBtn.addEventListener('click', () => createFileModal.style.display = 'none');
            confirmCreateFileBtn.addEventListener('click', createNewFile);
            
            // File upload modal
            cancelUploadBtn.addEventListener('click', () => uploadFileModal.style.display = 'none');
            confirmUploadBtn.addEventListener('click', uploadFiles);
            fileUploadEl.addEventListener('change', handleFileUploadChange);
            
            // ZIP modal
            cancelZipBtn.addEventListener('click', () => zipFilesModal.style.display = 'none');
            confirmZipBtn.addEventListener('click', createZipFile);
            
            // Pages modal
            closePagesModalBtn.addEventListener('click', () => pagesModal.style.display = 'none');
            savePagesSettingsBtn.addEventListener('click', savePagesSettings);
            
            // Commit actions
            commitChangesBtn.addEventListener('click', commitFileChanges);
            discardChangesBtn.addEventListener('click', discardFileChanges);
        }
        
        function switchTab(tabId) {
            // Update active tab button
            tabBtns.forEach(btn => {
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update active tab content
            tabContents.forEach(content => {
                if (content.id === `${tabId}Tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }
        
        // GitHub API functions
        async function callGitHubApi(url, method = 'GET', body = null) {
            const headers = {
                'Authorization': `token ${accessToken}`,
                'Accept': 'application/vnd.github.v3+json'
            };
            
            const options = {
                method,
                headers
            };
            
            if (body) {
                options.body = JSON.stringify(body);
                headers['Content-Type'] = 'application/json';
            }
            
            try {
                const response = await fetch(`https://api.github.com${url}`, options);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'GitHub API request failed');
                }
                
                return await response.json();
            } catch (error) {
                showError(`API Error: ${error.message}`);
                throw error;
            }
        }
        
        // User data functions
        async function loadUserData() {
            try {
                const user = await callGitHubApi('/user');
                currentUser = user;
                
                // Update UI
                usernameEl.textContent = user.login;
                userAvatarEl.src = user.avatar_url;
            } catch (error) {
                console.error('Failed to load user data:', error);
            }
        }
        
        // Repository functions
        async function loadRepositories() {
            try {
                repoListEl.innerHTML = '<li>Loading repositories...</li>';
                
                // Get all repositories (including those from organizations)
                const repos = await callGitHubApi('/user/repos?per_page=100&affiliation=owner,collaborator,organization_member');
                
                if (repos.length === 0) {
                    repoListEl.innerHTML = '<li>No repositories found</li>';
                    return;
                }
                
                // Sort by full name
                repos.sort((a, b) => a.full_name.localeCompare(b.full_name));
                
                // Render repository list
                repoListEl.innerHTML = '';
                repos.forEach(repo => {
                    const li = document.createElement('li');
                    li.className = 'repo-item';
                    li.textContent = repo.full_name;
                    li.dataset.repo = repo.full_name;
                    li.addEventListener('click', () => selectRepository(repo));
                    repoListEl.appendChild(li);
                });
            } catch (error) {
                repoListEl.innerHTML = '<li>Error loading repositories</li>';
                console.error('Failed to load repositories:', error);
            }
        }
        
        function selectRepository(repo) {
            currentRepo = repo.full_name;
            currentPath = '';
            currentFile = null;
            
            // Update UI
            repoNameEl.textContent = repo.full_name;
            welcomeViewEl.style.display = 'none';
            repoViewEl.style.display = 'block';
            
            // Reset tabs
            switchTab('files');
            
            // Load repository contents
            loadRepoContents(repo.full_name, '');
            loadCommitHistory(repo.full_name);
            
            // Update active repo in sidebar
            document.querySelectorAll('.repo-item').forEach(item => {
                if (item.dataset.repo === repo.full_name) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        async function loadRepoContents(repo, path) {
            try {
                fileTreeEl.innerHTML = 'Loading files...';
                fileContentEl.innerHTML = '<p>Select a file to view or edit</p>';
                commitSectionEl.style.display = 'none';
                
                const contents = await callGitHubApi(`/repos/${repo}/contents/${path}`);
                
                // Update breadcrumb
                updateBreadcrumb(repo, path);
                
                // Render file tree
                fileTreeEl.innerHTML = '';
                
                if (path) {
                    // Add ".." for navigating up
                    const parentItem = document.createElement('div');
                    parentItem.className = 'file-item';
                    parentItem.innerHTML = '<span class="icon">‚Ü©</span> ..';
                    parentItem.addEventListener('click', () => {
                        const parentPath = path.split('/').slice(0, -1).join('/');
                        loadRepoContents(repo, parentPath);
                    });
                    fileTreeEl.appendChild(parentItem);
                }
                
                // Separate directories and files
                const directories = contents.filter(item => item.type === 'dir');
                const files = contents.filter(item => item.type === 'file');
                
                // Add directories
                directories.forEach(item => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `<span class="icon">üìÅ</span> ${item.name}`;
                    fileItem.addEventListener('click', () => {
                        loadRepoContents(repo, item.path);
                    });
                    fileTreeEl.appendChild(fileItem);
                });
                
                // Add files
                files.forEach(item => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `<span class="icon">üìÑ</span> ${item.name}`;
                    fileItem.dataset.path = item.path;
                    fileItem.addEventListener('click', () => {
                        selectFile(item);
                    });
                    fileTreeEl.appendChild(fileItem);
                });
            } catch (error) {
                fileTreeEl.innerHTML = 'Error loading directory contents';
                console.error('Failed to load repository contents:', error);
            }
        }
        
        function updateBreadcrumb(repo, path) {
            breadcrumbEl.innerHTML = '';
            
            const parts = path.split('/');
            
            // Add root link
            const rootItem = document.createElement('span');
            rootItem.className = 'breadcrumb-item';
            rootItem.textContent = repo.split('/')[1] || repo;
            rootItem.dataset.path = '';
            rootItem.addEventListener('click', () => loadRepoContents(repo, ''));
            breadcrumbEl.appendChild(rootItem);
            
            // Add path parts
            let currentPath = '';
            parts.forEach((part, index) => {
                if (!part) return;
                
                currentPath += (currentPath ? '/' : '') + part;
                
                const separator = document.createElement('span');
                separator.className = 'breadcrumb-separator';
                separator.textContent = '/';
                breadcrumbEl.appendChild(separator);
                
                const item = document.createElement('span');
                item.className = 'breadcrumb-item';
                item.textContent = part;
                item.dataset.path = currentPath;
                item.addEventListener('click', () => loadRepoContents(repo, currentPath));
                breadcrumbEl.appendChild(item);
            });
        }
        
        async function selectFile(file) {
            try {
                currentFile = file;
                
                // Check if file is editable (text-based)
                const editableExtensions = ['.md', '.txt', '.html', '.css', '.js', '.json', '.java', '.py', '.php', '.sh', '.yml', '.yaml', '.xml'];
                const isEditable = editableExtensions.some(ext => file.name.endsWith(ext));
                
                if (isEditable) {
                    // Get file content
                    const fileData = await callGitHubApi(`/repos/${currentRepo}/contents/${file.path}`);
                    const content = atob(fileData.content);
                    fileContentOriginal = content;
                    
                    // Create editor
                    fileContentEl.innerHTML = `
                        <h4>${file.name}</h4>
                        <textarea class="editor" id="fileEditor">${content}</textarea>
                    `;
                    
                    fileEditor = document.getElementById('fileEditor');
                    fileEditor.addEventListener('input', () => {
                        if (fileEditor.value !== fileContentOriginal) {
                            commitSectionEl.style.display = 'block';
                        } else {
                            commitSectionEl.style.display = 'none';
                        }
                    });
                } else {
                    // Show download link for binary files
                    fileContentEl.innerHTML = `
                        <h4>${file.name}</h4>
                        <p>This file type cannot be edited directly.</p>
                        <a href="${file.download_url}" class="btn btn-primary" download>Download File</a>
                    `;
                    commitSectionEl.style.display = 'none';
                }
            } catch (error) {
                fileContentEl.innerHTML = '<p>Error loading file</p>';
                console.error('Failed to load file:', error);
            }
        }
        
        async function commitFileChanges() {
            if (!currentFile || !fileEditor) return;
            
            const newContent = fileEditor.value;
            const commitMessage = commitMessageEl.value.trim();
            
            if (!commitMessage) {
                showError('Please enter a commit message');
                return;
            }
            
            try {
                // Get the current SHA (needed for update)
                const fileData = await callGitHubApi(`/repos/${currentRepo}/contents/${currentFile.path}`);
                
                // Update file
                await callGitHubApi(`/repos/${currentRepo}/contents/${currentFile.path}`, 'PUT', {
                    message: commitMessage,
                    content: btoa(newContent),
                    sha: fileData.sha
                });
                
                // Reset UI
                commitMessageEl.value = '';
                commitSectionEl.style.display = 'none';
                fileContentOriginal = newContent;
                
                // Reload file to get updated SHA
                selectFile(currentFile);
                
                // Reload commit history
                loadCommitHistory(currentRepo);
            } catch (error) {
                console.error('Failed to commit changes:', error);
            }
        }
        
        function discardFileChanges() {
            if (fileEditor) {
                fileEditor.value = fileContentOriginal;
                commitSectionEl.style.display = 'none';
            }
        }
        
        async function loadCommitHistory(repo) {
            try {
                commitHistoryEl.innerHTML = 'Loading commit history...';
                
                const commits = await callGitHubApi(`/repos/${repo}/commits?per_page=10`);
                
                if (commits.length === 0) {
                    commitHistoryEl.innerHTML = '<p>No commits found</p>';
                    return;
                }
                
                commitHistoryEl.innerHTML = '';
                commits.forEach(commit => {
                    const commitItem = document.createElement('div');
                    commitItem.className = 'commit-item';
                    
                    const message = document.createElement('div');
                    message.textContent = commit.commit.message.split('\n')[0];
                    
                    const meta = document.createElement('div');
                    meta.className = 'commit-meta';
                    meta.innerHTML = `
                        <strong>${commit.commit.author.name}</strong>
                        committed on ${new Date(commit.commit.author.date).toLocaleString()}
                    `;
                    
                    commitItem.appendChild(message);
                    commitItem.appendChild(meta);
                    commitHistoryEl.appendChild(commitItem);
                });
            } catch (error) {
                commitHistoryEl.innerHTML = '<p>Error loading commit history</p>';
                console.error('Failed to load commit history:', error);
            }
        }
        
        // File operations
        function showCreateFileModal() {
            newFileNameEl.value = currentPath ? `${currentPath}/` : '';
            newFileContentEl.value = '';
            createFileModal.style.display = 'flex';
        }
        
        async function createNewFile() {
            const filePath = newFileNameEl.value.trim();
            const content = newFileContentEl.value;
            
            if (!filePath) {
                showError('Please enter a file path');
                return;
            }
            
            try {
                await callGitHubApi(`/repos/${currentRepo}/contents/${filePath}`, 'PUT', {
                    message: `Create ${filePath}`,
                    content: btoa(content)
                });
                
                createFileModal.style.display = 'none';
                loadRepoContents(currentRepo, currentPath);
                loadCommitHistory(currentRepo);
            } catch (error) {
                console.error('Failed to create file:', error);
            }
        }
        
        function showUploadFileModal() {
            uploadPathEl.value = currentPath ? `${currentPath}/` : '';
            fileUploadEl.value = '';
            zipOptionsEl.style.display = 'none';
            uploadFileModal.style.display = 'flex';
        }
        
        function handleFileUploadChange() {
            const files = fileUploadEl.files;
            if (files.length === 1 && files[0].name.endsWith('.zip')) {
                zipOptionsEl.style.display = 'block';
            } else {
                zipOptionsEl.style.display = 'none';
            }
        }
        
        async function uploadFiles() {
            const path = uploadPathEl.value.trim();
            const files = fileUploadEl.files;
            const extractZip = extractZipEl.checked;
            
            if (files.length === 0) {
                showError('Please select at least one file to upload');
                return;
            }
            
            // Handle ZIP file extraction
            if (extractZip && files.length === 1 && files[0].name.endsWith('.zip')) {
                try {
                    await extractAndUploadZip(files[0], path);
                    uploadFileModal.style.display = 'none';
                    loadRepoContents(currentRepo, currentPath);
                    loadCommitHistory(currentRepo);
                    return;
                } catch (error) {
                    console.error('Failed to extract and upload ZIP:', error);
                    return;
                }
            }
            
            // Handle regular file uploads
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const filePath = path + file.name;
                    
                    // Read file as base64
                    const base64Content = await readFileAsBase64(file);
                    
                    // Upload to GitHub
                    await callGitHubApi(`/repos/${currentRepo}/contents/${filePath}`, 'PUT', {
                        message: `Upload ${file.name}`,
                        content: base64Content.split(',')[1] // Remove data URL prefix
                    });
                }
                
                uploadFileModal.style.display = 'none';
                loadRepoContents(currentRepo, currentPath);
                loadCommitHistory(currentRepo);
            } catch (error) {
                console.error('Failed to upload files:', error);
            }
        }
        
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        async function extractAndUploadZip(zipFile, path) {
            // Note: This is a simplified implementation since we can't use JSZip
            // In a real app, you'd use a library like JSZip or implement proper ZIP extraction
            
            showError('ZIP extraction requires additional libraries. Please upload individual files instead.');
            throw new Error('ZIP extraction not fully implemented');
            
            // This is just a placeholder for the actual implementation
            // The real implementation would:
            // 1. Extract the ZIP file using a library
            // 2. For each file in the ZIP:
            //    a. Determine the full path in the repo (path + zip entry name)
            //    b. Upload the file content to GitHub
        }
        
        function showZipFilesModal() {
            if (!currentRepo) return;
            
            zipFileNameEl.value = `${currentRepo.split('/')[1] || 'archive'}_${new Date().toISOString().slice(0,10)}.zip`;
            zipFileListEl.innerHTML = 'Loading files...';
            selectedFilesForZip = [];
            zipFilesModal.style.display = 'flex';
            
            // Load all files in the repository for selection
            loadAllFilesForZip(currentRepo, currentPath);
        }
        
        async function loadAllFilesForZip(repo, path) {
            try {
                const contents = await callGitHubApi(`/repos/${repo}/contents/${path}`);
                
                zipFileListEl.innerHTML = '';
                
                // Process directories and files
                for (const item of contents) {
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `zip-file-${item.path}`;
                    checkbox.value = item.path;
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedFilesForZip.push(item.path);
                        } else {
                            selectedFilesForZip = selectedFilesForZip.filter(p => p !== item.path);
                        }
                    });
                    
                    const label = document.createElement('label');
                    label.htmlFor = `zip-file-${item.path}`;
                    label.innerHTML = `<span class="icon">${item.type === 'dir' ? 'üìÅ' : 'üìÑ'}</span> ${item.name}`;
                    
                    checkboxItem.appendChild(checkbox);
                    checkboxItem.appendChild(label);
                    zipFileListEl.appendChild(checkboxItem);
                    
                    // Recursively load contents of directories
                    if (item.type === 'dir') {
                        await loadAllFilesForZip(repo, item.path);
                    }
                }
            } catch (error) {
                zipFileListEl.innerHTML = 'Error loading files';
                console.error('Failed to load files for ZIP:', error);
            }
        }
        
        async function createZipFile() {
            const zipFileName = zipFileNameEl.value.trim();
            
            if (!zipFileName) {
                showError('Please enter a ZIP file name');
                return;
            }
            
            if (!zipFileName.endsWith('.zip')) {
                showError('File name must end with .zip');
                return;
            }
            
            if (selectedFilesForZip.length === 0) {
                showError('Please select at least one file or folder');
                return;
            }
            
            // Note: This is a simplified implementation since we can't use JSZip
            // In a real app, you'd use a library like JSZip to create the ZIP
            
            showError('ZIP creation requires additional libraries. This feature is not fully implemented.');
            zipFilesModal.style.display = 'none';
            
            // This is just a placeholder for the actual implementation
            // The real implementation would:
            // 1. For each selected file/folder:
            //    a. Download the file content
            //    b. Add to ZIP archive
            // 2. Generate the ZIP file
            // 3. Offer it for download
        }
        
        // GitHub Pages functions
        async function showPagesModal() {
            if (!currentRepo) return;
            
            pagesModal.style.display = 'flex';
            pagesStatusTextEl.textContent = 'Loading...';
            pagesStatusIndicatorEl.className = 'status-indicator';
            pagesBranchEl.disabled = true;
            pagesPathEl.disabled = true;
            pagesCNAMEEl.disabled = true;
            savePagesSettingsBtn.disabled = true;
            
            try {
                // Get Pages info
                const pagesInfo = await callGitHubApi(`/repos/${currentRepo}/pages`);
                
                // Get branches for source selection
                const branches = await callGitHubApi(`/repos/${currentRepo}/branches`);
                
                // Update UI with Pages info
                pagesStatusTextEl.textContent = pagesInfo.status || 'Unknown';
                pagesStatusIndicatorEl.classList.add(pagesInfo.status === 'built' ? 'status-active' : 'status-inactive');
                
                // Update branch selector
                pagesBranchEl.innerHTML = '';
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = branch.name;
                    if (pagesInfo.source && pagesInfo.source.branch === branch.name) {
                        option.selected = true;
                    }
                    pagesBranchEl.appendChild(option);
                });
                
                // Update path selector
                pagesPathEl.value = pagesInfo.source ? pagesInfo.source.path : '/';
                
                // Get CNAME if exists
                try {
                    const cnameFile = await callGitHubApi(`/repos/${currentRepo}/contents/CNAME`);
                    const cname = atob(cnameFile.content).trim();
                    pagesCNAMEEl.value = cname;
                } catch (error) {
                    pagesCNAMEEl.value = '';
                }
                
                // Update Pages URL
                if (pagesInfo.html_url) {
                    pagesUrlLinkEl.href = pagesInfo.html_url;
                    pagesUrlLinkEl.textContent = pagesInfo.html_url;
                    document.getElementById('pagesUrl').style.display = 'block';
                } else {
                    document.getElementById('pagesUrl').style.display = 'none';
                }
                
                // Enable controls
                pagesBranchEl.disabled = false;
                pagesPathEl.disabled = false;
                pagesCNAMEEl.disabled = false;
                savePagesSettingsBtn.disabled = false;
            } catch (error) {
                pagesStatusTextEl.textContent = 'Error loading Pages info';
                console.error('Failed to load Pages info:', error);
            }
        }
        
        async function savePagesSettings() {
            if (!currentRepo) return;
            
            const branch = pagesBranchEl.value;
            const path = pagesPathEl.value;
            const cname = pagesCNAMEEl.value.trim();
            
            try {
                // Save CNAME if changed
                if (cname) {
                    try {
                        // Check if CNAME already exists
                        const existingCname = await callGitHubApi(`/repos/${currentRepo}/contents/CNAME`);
                        
                        // Update existing
                        await callGitHubApi(`/repos/${currentRepo}/contents/CNAME`, 'PUT', {
                            message: 'Update CNAME',
                            content: btoa(cname),
                            sha: existingCname.sha
                        });
                    } catch (error) {
                        // Create new
                        await callGitHubApi(`/repos/${currentRepo}/contents/CNAME`, 'PUT', {
                            message: 'Add CNAME',
                            content: btoa(cname)
                        });
                    }
                } else {
                    // Try to delete CNAME if it exists
                    try {
                        const existingCname = await callGitHubApi(`/repos/${currentRepo}/contents/CNAME`);
                        await callGitHubApi(`/repos/${currentRepo}/contents/CNAME`, 'DELETE', {
                            message: 'Remove CNAME',
                            sha: existingCname.sha
                        });
                    } catch (error) {
                        // CNAME doesn't exist, nothing to do
                    }
                }
                
                // Update Pages source (GitHub API doesn't provide a direct way to do this)
                // In a real app, you might need to use a different approach or library
                
                showError('Pages source update requires additional implementation. Settings partially saved.');
                pagesModal.style.display = 'none';
            } catch (error) {
                console.error('Failed to save Pages settings:', error);
            }
        }
        
        // Utility functions
        function showError(message) {
            alert(`Error: ${message}`);
        }
    </script>
</body>
</html>
